<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello wasm-pack!</title>
    <style>
      body {
        background-color: rgb(58, 58, 58);
        color: white;
      }
    </style>
  </head>
  <body>
    <noscript>This page contains webassembly and javascript content, please enable javascript in your browser.</noscript>
    <script type="module">
      // import { fetchWasm } from "/pkg/wasm_demo.js";

      let startBtn = document.getElementById('start-sound');

      async function setup() {
        const bin = await WebAssembly.compileStreaming(await fetch('/www/wasm_demo.wasm'));
        // const buf = await bin.arrayBuffer();

        let context =  new AudioContext();
        console.log("adding module");
        await context.audioWorklet.addModule('processor.js');
        let node = new AudioWorkletNode(context, 'web-synth-proto');
        node.port.postMessage({type: 'init-wasm', wasmData: bin});
        node.connect(context.destination);

        let stopBtn = document.getElementById('stop-sound');
        stopBtn.addEventListener('click', () => {
          context.close();
        });
      }

      startBtn.addEventListener('click', () => {
        setup();
      });
    </script>
    <button id="start-sound">Start Sound</button>
    <button id="stop-sound">Stop Sound</button>
  </body>
</html>
